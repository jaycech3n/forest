{{ $site := .context.Site }}

{{ $taxon := .context.Params.Taxon }}
{{ $macrolib := .context.Params.macrolib }}
{{ $title := .context.Page.Title }}
{{ $relPermalink := .context.Page.RelPermalink }}
{{ $slug := .context.Page.File.ContentBaseName }}
{{ $shouldCollapse := default false .collapse }}
{{ $shouldExpand := not $shouldCollapse }}
{{ $pageChildren := default slice (.context.Page.Store.Get "dwdSlugs") }}
{{ $splice := .splice }}

{{ $macros := dict }}
{{ with $macrolib }}
  {{ $macrolibFile := print . ".katex.json" }}
  {{ with resources.Get $macrolibFile }}
    {{ $macros = .Content | transform.Unmarshal }}
  {{ end }}
{{ end }}

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    renderMathContentForSlug({{$macros}}, {{$slug}})
  })
</script>

{{ if $splice }}
<section class="block math-barrier splice">
  {{- with .context -}}
    {{- if .Content }}
    <div class="post-content" data-slug="{{$slug}}">
      {{.Content}}
    </div>
    {{- end }}
  {{- end -}}
  </details>
</section>


{{else}}

<section class="block math-barrier" data-slug="{{$slug}}">
  <details {{if $shouldExpand}} open {{end}} data-slug="{{$slug}}">
    <summary>
      {{ if eq .context.Page.Type "refs" }}
        {{- partial "bibitem_summary.html" .context.Page.Params -}}
        <a href="{{$relPermalink}}" class="slug">#{{$slug}}</a>
      {{ else }}
        {{ if $taxon }}
        <b>{{ $taxon }}</b>
        {{with $title}} ({{.}}) {{end}}
        <a href="{{$relPermalink}}" class="slug">#{{$slug}}</a>
        {{ else }}
        <b> {{ $title | title | markdownify }} </b> <a href="{{$relPermalink}}" class="slug">#{{$slug}}</a>
        {{ end }}

        {{ if .context.Params.Draft }}
        <sup>
          <span class="entry-isdraft">  [draft]</span>
        </sup>
        {{ end }}
      {{ end }}
    </summary>

    {{- with .context -}}
      <div class="post-content" data-slug="{{$slug}}">
        {{.Content}}
      </div>
    {{- end -}}
  </details>
</section>

{{end}}
