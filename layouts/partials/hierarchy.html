{{ $site := .context.Site }}
{{ $taxon := .context.Params.Taxon }}
{{ $macrolib := .context.Params.macrolib }}
{{ $title := .context.Page.Title }}
{{ $relPermalink := .context.Page.RelPermalink }}
{{ $slug := .context.Page.File.ContentBaseName }}
{{ $trail := .trail }}

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    const sectionElement = document.getElementById({{ $slug }});
    renderMathInElement(sectionElement, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true }
      ],
      throwOnError: false,
      {{ with $macrolib }}
        {{ $macrolibFile := print . ".katex.json" }}
        {{ with resources.Get $macrolibFile }}
        macros: {{.Content | transform.Unmarshal }}
        {{ end }}
      {{ end }}
    });
  })
</script>

<section class="block">

  <details {{ if lt (len .trail) 1000 }} open {{end}}>
    <summary>
      {{ if $taxon }}
      <b>{{ $taxon }} {{ partial "trail.html" (dict "context" . "trail" $trail) }} </b> ({{ $title }})
      <a href="{{$relPermalink}}" class="slug">#{{$slug}}</a>
      {{ else }}
      <h1>
        ยง{{- partial "trail.html" (dict "context" . "trail" $trail) -}}.
        {{ $title }}
        <a href="{{$relPermalink}}" class="slug">#{{$slug}}</a>
      </h1>
      {{ end }}
    </summary>

    {{- with .context -}}
    {{- if .Content }}
    <div class="post-content" id="{{$slug}}">
      {{- if not (.Param "disableAnchoredHeadings") }}
      {{- partial "anchored_headings.html" .Content -}}
      {{- else }}{{ .Content }}{{ end }}
    </div>
    {{- end }}
    {{- end -}}


    {{ range $child_ix, $child := .context.Params.Children }}
    {{ with $site.GetPage $child }}
    {{ partial "hierarchy.html"
    (dict
    "context" .
    "trail" (append (slice $child_ix) $trail)) }}
    {{ end }}
    {{ end }}

  </details>
</section>
