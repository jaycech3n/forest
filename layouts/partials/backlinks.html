{{ $bwdPages := slice }}
{{ $fwdPages := slice }}
{{ $upwdPages := slice }}

{{ $page := .page }}

{{ range where site.RegularPages "RelPermalink" "ne" $page.RelPermalink }}
  {{ if in .Params.Children $page.File.ContentBaseName }}
    {{ $upwdPages = $upwdPages | append . }}
  {{ end }}

  {{ if or (in .Params.Related $page.File.ContentBaseName) (findRE $page.RelPermalink .Content 1) }}
    {{ $bwdPages = $bwdPages | append . }}
  {{ else if or (in $page.Params.Related .File.ContentBaseName) (findRE .RelPermalink $page.Content 1) }}
    {{ $fwdPages = $fwdPages | append . }}
  {{ end }}
{{ end }}

{{ with $upwdPages }}
<section class="backlinks">
  {{ printf "%s" ($.heading | default "<h4>Context</h4>") | safeHTML }}
  <nav>
    <ul>
      {{ range . }}
      <li>
        <a class="local" href="{{ .RelPermalink }}">
          {{with .Title}}
          {{. | markdownify}}
          {{end}}
          <span class="slug">#{{.File.ContentBaseName}}</span>
        </a>
      </li>
      {{ end }}
    </ul>
  </nav>
</section>
{{ end }}

{{ with $fwdPages }}
<section class="backlinks">
  {{ printf "%s" ($.heading | default "<h4>Related</h4>") | safeHTML }}
  <nav>
    <ul>
      {{ range . }}
      <li>
        <a class="local" href="{{ .RelPermalink }}">
          {{with .Title}}
          {{. | markdownify}}
          {{end}}
          <span class="slug">#{{.File.ContentBaseName}}</span>
        </a>
      </li>
      {{ end }}
    </ul>
  </nav>
</section>
{{ end }}


{{ with $bwdPages }}
<section class="backlinks">
  {{ printf "%s" ($.heading | default "<h4>Backlinks</h4>") | safeHTML }}
  <nav>
    <ul>
      {{ range . }}
      <li>
        <a class="local" href="{{ .RelPermalink }}">
          {{with .Title |}}
          {{. | markdownify}}
          {{end}}
          <span class="slug">#{{.File.ContentBaseName}}</span>
        </a>
      </li>
      {{ end }}
    </ul>
  </nav>
</section>
{{ end }}
