{{ $page := .page }}
{{ $slug := $page.File.ContentBaseName }}

{{ $fwdPages := slice }}
{{ $bwdPages := slice }}
{{ $dwdPages := slice }}
{{ $upwdPages := slice }}
{{ $refPages := slice }}

{{ with site.Data.forest }}
  {{ with .linksTo }}
    {{ range index . $slug }}
      {{ with site.GetPage . }}
        {{ $bwdPages = $bwdPages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with .linksFrom }}
    {{ range index . $slug }}
      {{ with site.GetPage . }}
        {{ if eq .Type "refs" }}
          {{ $refPages = $refPages | append . }}
        {{ else }}
          {{ $fwdPages = $fwdPages | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with .parentsOf }}
    {{ range index . $slug }}
      {{ with site.GetPage . }}
        {{ $upwdPages = $upwdPages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with .childrenOf }}
    {{ range index . $slug }}
      {{ with site.GetPage . }}
        {{ $dwdPages = $dwdPages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ with $upwdPages }}
  {{ partial "links_section" (dict "pages" . "title" "Context" "id" "context")}}
  {{ end }}

  {{ with $fwdPages }}
  {{ partial "links_section" (dict "pages" . "title" "Related" "id" "related")}}
  {{ end }}

  {{ with $bwdPages }}
  {{ partial "links_section" (dict "pages" . "title" "Backlinks" "id" "backlinks")}}
  {{ end }}

  {{ with $refPages }}
  {{ partial "links_section" (dict "pages" . "title" "id" "references" "References")}}
  {{ end }}

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const highlightIn = (containerSelector, highlightSelector) => {
        document.querySelectorAll(containerSelector).forEach((nav) => {
          nav.querySelectorAll(highlightSelector).forEach((el) => {
            if (el.getAttribute('data-slug') == "{{$slug}}") {
              el.classList.add('highlighted')
            }
          })
        })
      }

      highlightIn('nav#context', 'section')
      highlightIn('nav#backlinks', 'a')
      highlightIn('nav#related', 'a')
    })
  </script>

{{ end }}
